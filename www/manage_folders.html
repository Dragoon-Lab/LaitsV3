<html>
<head>
	<script type="text/javascript" 
        data-dojo-config = "
        	isDebug: true, 
        	parseOnLoad: true,
        	async: 1,
        	dojoBlankHtmlUrl: '/blank.html'"
         src="http://ajax.googleapis.com/ajax/libs/dojo/1.9.1/dojo/dojo.js" ></script>

	<link rel="stylesheet" type="text/css" href="http://ajax.googleapis.com/ajax/libs/dojo/1.9.1/dijit/themes/claro/claro.css"/>
	<script>
		require(["dojo/parser",
				 "dojo/dom",
				 "dojo/_base/array",
				 "dojo/on",
				 "dojo/dom",
				 "dijit/registry",
				 "dojo/store/Memory",
				 "dijit/form/ComboBox",
				 "dijit/form/TextBox",
				 "dijit/form/Button",
				 "dijit/form/MultiSelect",
	         	 "dojo/ready",
	         	 "dojo/domReady!"],
	         	 function(parser, dom, array, on, dom, registry, Memory, comboBox, textBox, button, MultiSelect, ready){
	         	 	section_folders =[];
	         	 	user_folders = [];
	         	 	isSectionsModified = false;

	         	 	ready(function(){
	         	 		fetchSections();

	         	 		on(registry.byId("select_section"), "change", function(){
	         	 			fetchFoldersforSections();
	         	 		});

	         	 		on(registry.byId("select_user_section"), "change", function(){
	         	 			fetchUsers();
	         	 		});

	         	 		on(registry.byId("btn_add_folder_section"), "click", function(){
	         	 			var folder = registry.byId("add_folder_section").value;
	         	 			var folder_select = dom.byId("select_folders_section");
	         	 			if(section_folders.indexOf(folder) == -1){
		         	 			var c = document.createElement('option');
								c.innerHTML = folder ;
								c.value = folder;
								folder_select.appendChild(c);
								section_folders.push(folder);
								isSectionsModified = true;
							}else{
								alert("Folder already added");
							}
							registry.byId("add_folder_section").set("value","");
	         	 		});

	         	 		on(registry.byId("btn_remove_folder_section"), "click", function(){
	         	 			var values = registry.byId("select_folders_section").value;
	         	 			if(values && values[0]!==""){
		         	 			array.forEach(values, function(value){
		         	 				var index = section_folders.indexOf(value);
		         	 				if(index != -1){
		         	 					section_folders.splice(index,1);
		         	 					isSectionsModified = true;
		         	 				}
		         	 			});
		         	 			var folder_select = dom.byId("select_folders_section");
		         	 			while (folder_select.hasChildNodes()) {
	                                folder_select.removeChild(folder_select.lastChild);
	                            }
	                            //Load options
	         	 				array.forEach(section_folders, function(folder){
									var c = document.createElement('option');
							        c.innerHTML = folder;
							        c.value = folder;
							        folder_select.appendChild(c);
	         	 				});
         	 				}
	         	 		});

	         	 		on(registry.byId("btn_update_section_folders"), "click", function(){
	         	 				var sid = registry.byId("select_section").item.id;
	         	 				var folders = JSON.stringify(section_folders);
	         	 				dojo.xhrPost({
	         	 					url:"manage_sections.php",
	         	 					postData:"op=update&section="+sid+"&groups="+folders,
	         	 					handleAs:"text",
	         	 					load: function(resposne){
	         	 						console.log(response);
	         	 					},
	         	 					error: function(error){

	         	 					}
	         	 				});
	         	 		});

	         	 		on(registry.byId("select_user"), "change", function(){
	         	 			fetchFoldersforUser();
	         	 			//fetchUsers();
	         	 		});

	         	 		on(registry.byId("btn_add_folder_user"), "click", function(){
	         	 			var folder = registry.byId("add_folder_user").value;
	         	 			var folder_select = dom.byId("select_folders_user");
	         	 			if(section_folders.indexOf(folder) == -1){
		         	 			var c = document.createElement('option');
								c.innerHTML = folder ;
								c.value = folder;
								folder_select.appendChild(c);
								user_folders.push(folder);
								isSectionsModified = true;
							}else{
								alert("Folder already added");
							}
							registry.byId("add_folder_user").set("value","");
	         	 		});

	         	 		on(registry.byId("btn_remove_folder_user"), "click", function(){
	         	 			var values = registry.byId("select_folders_user").value;
	         	 			if(values && values[0]!==""){
		         	 			array.forEach(values, function(value){
		         	 				var index = user_folders.indexOf(value);
		         	 				if(index != -1){
		         	 					user_folders.splice(index,1);
		         	 					isSectionsModified = true;
		         	 				}
		         	 			});
		         	 			var folder_select = dom.byId("select_folders_user");
		         	 			while (folder_select.hasChildNodes()) {
	                                folder_select.removeChild(folder_select.lastChild);
	                            }
	                            //Load options
	         	 				array.forEach(user_folders, function(folder){
									var c = document.createElement('option');
							        c.innerHTML = folder;
							        c.value = folder;
							        folder_select.appendChild(c);
	         	 				});
         	 				}
	         	 		});

						on(registry.byId("btn_update_user_folders"), "click", function(){
								var username = registry.byId("select_user").value;
	         	 				var sid = registry.byId("select_user_section").item.id;
	         	 				var folders = JSON.stringify(user_folders);
	         	 				dojo.xhrPost({
	         	 					url:"manage_user_groups.php",
	         	 					postData:"op=update&username="+username+"&section="+sid+"&groups="+folders,
	         	 					handleAs:"text",
	         	 					load: function(resposne){
	         	 						console.log(response);
	         	 					},
	         	 					error: function(error){

	         	 					}
	         	 				});
	         	 		});
						on(registry.byId("btn_add_new_section"), "click", function(){
	         	 			addSection();
	         	 		});

	         	 		on(registry.byId("btn_add_new_user"), "click", function(){
	         	 			addUser();
	         	 		});

	         	 		
	         	 	 });

	         	 	function fetchSections(){
	         	 		dojo.xhrGet({
	         	 			url:"manage_sections.php",
	         	 			handleAs: "json",
	         	 			load:function(response){
	         	 				var section_options = [];
	         	 				array.forEach(response, function(section){
									section_options.push({"name": section.section_name , "id": section.section_id})
	         	 				});
	         	 				var memoryStore = new Memory({data: section_options});

	         	 				registry.byId("select_section").set("store", memoryStore);
	         	 				registry.byId("select_user_section").set("store", memoryStore);
	         	 				registry.byId("select_section").startup();
	         	 				registry.byId("select_user_section").startup();
	         	 			},
	         	 			error: function(error){

	         	 			}
	         	 		});
	         	 	}

	         	 	function fetchFoldersforSections(){
	         	 		var folder_select = dom.byId("select_folders_section");
	         	 		while (folder_select.hasChildNodes()) {
                                    folder_select.removeChild(folder_select.lastChild);
                                }
                         try{       
			         	 		var sid = registry.byId("select_section").item.id;

			         	 		dojo.xhrPost({
			         	 			url:"available_folders.php",
			         	 			postData:"section="+sid,
			         	 			handleAs: "json",
			         	 			load:function(response){
			         	 				section_folders = response;
			         	 				var folder_options = [];
			         	 				//Clear Multiselect 
			         	 				
		                                if(response.length == 0){
		                                	var c = document.createElement('option');
									        c.innerHTML = "No folders in this section";
									        c.value = "";
									        folder_select.appendChild(c);
		                                }else{
			                                //Load options
				         	 				array.forEach(response, function(folder){
												var c = document.createElement('option');
										        c.innerHTML = folder;
										        c.value = folder;
										        folder_select.appendChild(c);
				         	 				});
			         	 				}
			         	 				registry.byId("select_folders_section").set("disabled", false);
			         	 				registry.byId("select_folders_section").startup();
			         	 			},
			         	 			error: function(error){

			         	 			}
			         	 		});
							}catch(e){
								console.log(e);
							}	
	         	 	}

	         	 	function fetchUsers(){
	         	 		registry.byId("select_user").set("value", "");
	         	 		var sid = registry.byId("select_user_section").item.id;
	         	 		dojo.xhrGet({
	         	 			url:"manage_user_groups.php?section="+sid,
	         	 			handleAs: "json",
	         	 			load:function(response){
	         	 				var user_options = [];
	         	 				if(response != null){		
		         	 				array.forEach(response, function(user){
										user_options.push({"name": user.username , "id": user.username})
		         	 				});
	         	 				}
	         	 				var memoryStore = new Memory({data: user_options});

	         	 				registry.byId("select_user").set("store", memoryStore);
	         	 				registry.byId("select_user").startup();
	         	 			},
	         	 			error: function(error){

	         	 			}
	         	 		});
	         	 	}

	         	 	function fetchFoldersforUser(){
	         	 		var username = registry.byId("select_user").value;
	         	 		var sid = registry.byId("select_user_section").item.id;
	         	 		dojo.xhrPost({
	         	 			url:"available_folders.php",
	         	 			postData:"section="+sid+"&username="+username,
	         	 			handleAs: "json",
	         	 			load:function(response){
	         	 				console.log(response);
	         	 				user_folders = response;
	         	 				var folder_options = [];
	         	 				//Clear Multiselect 
	         	 				var folder_select = dom.byId("select_folders_user");
	         	 				while (folder_select.hasChildNodes()) {
                                    folder_select.removeChild(folder_select.lastChild);
                                }
                                if(response.length == 0){
                                	var c = document.createElement('option');
							        c.innerHTML = "No folders in this section";
							        c.value = "";
							        folder_select.appendChild(c);
                                }else{
	                                //Load options
		         	 				array.forEach(response, function(folder){
										var c = document.createElement('option');
								        c.innerHTML = folder;
								        c.value = folder;
								        folder_select.appendChild(c);
		         	 				});
	         	 				}
	         	 				registry.byId("select_folders_user").set("disabled", false);
	         	 				registry.byId("select_folders_user").startup();
	         	 			},
	         	 			error: function(error){

	         	 			}
	         	 		});
	         	 	}

	         	 	function addSection(){
	         	 		var section = registry.byId("add_section").value;
     	 				dojo.xhrPost({
     	 					url:"manage_sections.php",
     	 					postData:"op=add&name="+section,
     	 					handleAs:"text",
     	 					load: function(resposne){
     	 						fetchSections();
     	 						registry.byId("add_section").set("value","");
     	 					},
     	 					error: function(error){

     	 					}
     	 				});
	         	 	}

	         	 	function addUser(){
	         	 		var username = registry.byId("add_user").value;
	         	 		var section = registry.byId("select_user_section").item.id;
     	 				dojo.xhrPost({
     	 					url:"manage_user_groups.php",
     	 					postData:"op=add&username="+username+"&section="+section,
     	 					handleAs:"text",
     	 					load: function(resposne){
     	 						fetchUsers();
     	 						registry.byId("add_user").set("value","");
     	 					},
     	 					error: function(error){

     	 					}
     	 				});
	         	 	}

	         });
	</script>
	<style>
		.box{
			display:inline-block;
			width:350px;
			border: 1px solid #DFDCDC;
			background: url("css/form-fieldset.gif") repeat-x scroll left bottom #F8FDEF;
			padding:15px;
			border-radius:10px;
			vertical-align: top;
		}
		body{
			background: #C6F5F2;
		}
	</style>
</head>

<body class="claro">
	<h2>Manage Section Folders</h2>
	<hr/>
	<div id="addSection" class="box">
		<form>
			<label for="add_section"> Section Name:</label><br/>
			<input data-dojo-type="dijit.form.TextBox" id="add_section" name="section"/><br/>
			<button type="button" data-dojo-type="dijit.form.Button" id="btn_add_new_section"/>Add Section</button>
			<br/>
		</form>
	</div>
	<div id="section" class="box">
		<form>
			<label for="select_section">Select a section:</label><br/>
			<input data-dojo-type="dijit.form.ComboBox" id="select_section" name="section"/>
			<br/>
			<br/>
			<label for="add_folder_section"> Add Group to section:</label><br/>
			<input data-dojo-type="dijit.form.TextBox" id="add_folder_section" name="folders"/>
			<button type="button" data-dojo-type="dijit.form.Button" id="btn_add_folder_section"/>Add</button>
			<br/>
			<select style="width:240px; height:200px;" data-dojo-type="dijit.form.MultiSelect" id="select_folders_section" name="select_folder_section" disabled=true>
				<option value=""> No Section selected</option>
			</select>
			<button type="button" data-dojo-type="dijit.form.Button" id="btn_remove_folder_section"/>Remove</button>
			<br/>
			<br/>
			<button type="button" data-dojo-type="dijit.form.Button" id="btn_update_section_folders"/>Update</button>
		</form>
	</div>
	<br/>
	<br/>
	<h2>Manage User Folders</h2>
	<hr/>
	<label for="select_section">Select a section:</label><br/>
			<input data-dojo-type="dijit.form.ComboBox" id="select_user_section" name="section"/>
			<br/>
	<div id="addUser" class="box">
		<form>
			<label for="add_user"> Username:</label><br/>
			<input data-dojo-type="dijit.form.TextBox" id="add_user" name="user"/><br/>
			<button type="button" data-dojo-type="dijit.form.Button" id="btn_add_new_user"/>Add User</button>
			<br/>
		</form>
	</div>
	<div id="users" class="box">
		<form>
			<label for="select_user">Select a User:</label><br/>
			<input data-dojo-type="dijit.form.ComboBox" id="select_user" name="section"/>
			<br/>
			<br/>
			<label for="add_folder_user"> Add folder for user:</label><br/>
			<input data-dojo-type="dijit.form.TextBox" id="add_folder_user" name="folders"/>
			<button type="button" data-dojo-type="dijit.form.Button" id="btn_add_folder_user"/>Add</button>
			<br/>
			<select style="width:240px; height:200px;" data-dojo-type="dijit.form.MultiSelect" id="select_folders_user" name="select_folder_user">
				<option value=""> No User selected</option>
			</select>
			<button type="button" data-dojo-type="dijit.form.Button" id="btn_remove_folder_user"/>Remove</button>
			<br/>
			<br/>
			<button type="button" data-dojo-type="dijit.form.Button" id="btn_update_user_folders"/>Update</button>
		</form>
	</div>

</body>
</html>