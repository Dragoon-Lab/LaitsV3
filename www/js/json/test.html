<!DOCTYPE html>
<!--
    File to test loading and saving with Dojo. Uses load-save.js and model.js.
    Author: Brandon Strong
-->
<html>
    <head>
        <meta charset="utf-8"/>
        <title>POST/GET Testing</title>
    </head>
    <body>
        <h1>POST/GET Testing</h1>
        <p>This is a test file to check how to load problems and save problems from files and from the database.</p>

        <script src="//ajax.googleapis.com/ajax/libs/dojo/1.8.5/dojo/dojo.js" data-dojo-config="async: true"></script>

        <script>


            var file = "jsonExample.json";
            var jsonString = '{"task": { "phase": "intro", "type": "construct", "properties": { "taskName": "Rabbits - Intro Problem", "URL": "images/rabbit.jpeg", "startTime": 0, "endTime": 10, "timeStep": 1, "units": "years" }, "taskDescription": "In this exercise, you will construct a model of how a rabbit population grows when no rabbits die. The first quantity in this model is the population or number of rabbits in the population. Initially, there are 100 rabbits, but the number increases with time. The new population each month is its present value plus the number of births (number of rabbits born each month). The number of births is equal to the product of the population and the birth rate. The birthrate or the ratio of the number of rabbits born in a month to the rabbit population that month has a fixed value of 0.2.", "givenModelNodes": [ { "ID": "id1", "name": "population", "type": "stock", "parentNode": false, "extra": false, "order": 1, "units": "rabbits", "inputs": [ { "ID": "id2" } ], "position": { "x": 100, "y": 100 }, "initial": 100, "equation": "+ id2", "correctDesc": "The number of rabbits in the population", "attemptCount": { "desc": 2, "plan": 1, "calc": 1 }, "solution": { "desc": "correct", "plan": "demo", "calc": "correct" } }, { "ID": "id2", "name": "births", "type": "flow", "parentNode": true, "extra": false, "order": 2, "units": "births", "inputs": [ { "ID": "id1" }, { "ID": "id3" } ], "position": { "x": 300, "y": 100 }, "initial": "", "equation": "id1 * id3", "correctDesc": "The number of rabbits born each month", "attemptCount": { "desc": 2, "plan": 1, "calc": 3 }, "solution": { "desc": "correct", "plan": "correct", "calc": "demo" } }, { "ID": "id3", "name": "birth rate", "type": "constant", "parentNode": false, "extra": false, "order": 3, "units": "percent", "inputs": [], "position": { "x": 500, "y": 100 }, "initial": "", "equation": ".2", "correctDesc": "The ratio of number of rabbits born in a month to the rabbit population that month", "attemptCount": { "desc": 2, "plan": 1, "calc": 1 }, "solution": { "desc": "correct", "plan": "correct", "calc": "correct" } } ], "studentModelNodes": [ { "ID": "id1", "name": "population", "inGivenModel": true, "inputs": [ { "ID": "id2" } ], "position": { "x": 700, "y": 100 }, "studentSelections": { "desc": "The number of rabbits in the population", "plan": "stock", "units": "rabbits", "initial": 100, "equation": "+ id2" } }, { "ID": "id2", "name": "births", "inGivenModel": true, "inputs": [ { "ID": "id1" }, { "ID": "id3" } ], "position": { "x": 900, "y": 100 }, "studentSelections": { "desc": "The number of rabbits born each month", "plan": "flow", "units": "births", "initial": null, "equation": "id1 * id3" } }, { "ID": "id3", "name": "birth rate", "inGivenModel": true, "inputs": [], "position": { "x": 1100, "y": 100 }, "studentSelections": { "desc": "The ratio of number of rabbits born in a month to the rabbit population that month", "plan": "constant", "units": "percent", "initial": null, "equation": "0.2" } } ] } }';

            require(["/laits/js/json/load-save.js", "dojo/request/xhr", "dojo/_base/Deferred", "/laits/js/json/model"],
                    function(loadSave, xhr, deferred, model) {
                        xhr("/laits/js/json/" + file, {
                            //the xhr() function loads a problem from a JSON formatted text file
                            handleAs: "text"
                        }).then(function(string) {
                            // the parameter "string" holds the JSON formatted text string which is loaded into the "rabbits" object
                            var rabbits = new model(null, null, null, null, null, null);
                            rabbits.loadModel(string);
                            rabbits.setTaskName("Bugs"); // change the problem's name
                            // create a new load-save.js object called "problem"
                            var problem = new loadSave("Yosemiti", "12345", "Sam", rabbits.getModelAsString());
                            // save the problem and then re-load it again from the database
                            problem.saveProblem();
                            var a = problem.loadFromDB();
                            // loadFromDB() returns a Dojo Promise which can be read using Dojo Deferred
                            deferred.when(a, function(value) {
                                console.log(value);
                            });
                        });
                        
                        // Similar to above, but trying it again with the xhr() function in the load-save.js file
                        // and using its returned promise
                        var problem2 = new loadSave("YosemitiSam", "12345", "Iam", null);
                        var b = problem2.loadFromFile(file);
                        deferred.when(b, function(value) {
                            var rabbits2 = new model(null, null, null, null, null, null);
                            rabbits2.loadModel(value);
                            rabbits2.setTaskName("Bunny"); // change the problem's name
                            console.log(rabbits2.getModelAsString());
                        });
                    });
        </script>
    </body>
</html>
